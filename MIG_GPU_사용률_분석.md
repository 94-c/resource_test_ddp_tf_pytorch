# MIG 환경에서 GPU 사용률 메트릭 차이점 분석

## 📊 GPU 사용률 분석 개요

MIG(Multi-Instance GPU) 환경에서 GPU 사용률을 측정할 때 **원메트릭(단순 평균)**과 **가중 평균** 방식의 차이점을 분석하여 정확한 사용률 측정 방법을 제시합니다.

## 🔍 구체적인 예시 상황

### 현재 MIG 구성
- **물리적 GPU**: A100 80GB 1개
- **MIG 인스턴스 분할**:
  - `1g.10gb` 인스턴스 × 3개: 90%, 80%, 70% 사용률
  - `2g.20gb` 인스턴스 × 1개: 60% 사용률

## 📈 두 가지 사용률 계산 방법

### 1. 원메트릭 (단순 평균) 방식
```
사용률 = (90% + 80% + 70% + 60%) ÷ 4 = 75%
```
> **결과**: "GPU가 75% 사용 중입니다"

### 2. 가중 평균 방식 (실제 리소스 기준)
```
슬라이스 가중치:
- 1g.10gb = 1/7 (14.3%)
- 2g.20gb = 2/7 (28.6%)

계산:
(90% × 0.143 + 80% × 0.143 + 70% × 0.143 + 60% × 0.286) ÷ (0.143 × 3 + 0.286 × 1)
= (12.9 + 11.4 + 10.0 + 17.2) ÷ 0.715
= 72.2%
```
> **결과**: "실제 물리적 GPU가 72.2% 사용 중입니다"

## 💡 왜 다른 사용률이 나올까요?

| 관점 | 원메트릭 (단순 평균) | 가중 평균 |
|------|-------------------|-----------|
| **기준** | 인스턴스 개수 | 실제 GPU 리소스 |
| **2g 인스턴스** | 1개로 취급 | 2개 만큼의 영향력 |
| **의미** | 인스턴스들 평균 사용률 | 물리적 GPU 활용률 |

### 🤔 가중 평균이 정말 "사용률"일까요?

사실 두 방식 모두 나름의 의미가 있습니다:

**원메트릭 (단순 평균)**:
- **정의**: 각 MIG 인스턴스의 사용률 평균
- **의미**: "각 작업들이 평균적으로 얼마나 GPU를 사용하고 있는가?"
- **관점**: 인스턴스 중심

**가중 평균**:
- **정의**: 물리적 GPU 슬라이스 크기를 고려한 전체 활용률
- **의미**: "전체 물리적 GPU 리소스 중 실제로 얼마나 활용되고 있는가?"
- **관점**: 하드웨어 리소스 중심

### 🎯 정확한 표현은?

- **원메트릭**: "MIG 인스턴스들의 평균 사용률"
- **가중 평균**: "물리적 GPU의 실제 활용률"

둘 다 "사용률"이지만, **관점이 다릅니다**!

### 🏠 쉬운 비유: 아파트 단지 전기 사용량

**상황**: 원룸 3개(각각 90%, 80%, 70% 사용) + 투룸 1개(60% 사용)

- **원메트릭**: "각 가구의 평균 사용률은 75%입니다"
  - 관점: 가구 중심 (각 가구가 평균적으로 얼마나 사용하는가?)
  
- **가중 평균**: "전체 단지 전력 용량의 72.2%를 사용하고 있습니다"
  - 관점: 시설 중심 (전체 전력 인프라가 얼마나 활용되고 있는가?)

### 🔍 구체적인 예시로 이해해보기

**시나리오**: A100 GPU 1개를 다음과 같이 분할
- 1g.10gb × 3개: 각각 90%, 80%, 70% 사용률
- 2g.20gb × 1개: 60% 사용률

**질문에 따른 답변**:

1. **"각 작업들이 평균적으로 얼마나 GPU를 사용하고 있나요?"**
   - 답: 75% (원메트릭)
   - 의미: 4개 작업의 평균 사용률

2. **"전체 GPU 하드웨어가 얼마나 활용되고 있나요?"**
   - 답: 72.2% (가중 평균)
   - 의미: 물리적 GPU 컴퓨팅 리소스 활용률

3. **"GPU 서버의 전력 소비량을 예측한다면?"**
   - 답: 72.2% (가중 평균)
   - 이유: 큰 인스턴스가 더 많은 전력을 사용

4. **"각 개발팀의 평균 성능을 비교한다면?"**
   - 답: 75% (원메트릭)
   - 이유: 인스턴스 크기와 상관없이 각 팀의 사용률 비교

## 🎯 실무에서 어떻게 설명하나요?

### 🔧 기술팀에게
> "MIG 환경에서는 각 인스턴스가 차지하는 GPU 슬라이스 크기가 다릅니다.  
> 원메트릭은 인스턴스 개수만 고려하지만,  
> 가중 평균은 실제 물리적 GPU 사용률을 정확히 반영합니다."

### 📊 관리자에게
> "GPU 사용률을 정확히 파악하려면 가중 평균을 봐야 합니다.  
> 예를 들어, 작은 인스턴스 3개와 큰 인스턴스 1개가 있을 때,  
> 큰 인스턴스의 영향을 제대로 반영해야 실제 비용과 성능을 알 수 있습니다."

## 📈 프로메테우스 쿼리로 구현

### 원메트릭 (단순 평균) 쿼리
```promql
# 일반적으로 사용하는 방식
avg(DCGM_FI_PROF_GR_ENGINE_ACTIVE{pod="your-pod"})
```

### 가중 평균 쿼리 (정확한 GPU 사용률)
```promql
(
  sum(DCGM_FI_PROF_GR_ENGINE_ACTIVE{pod="your-pod", GPU_I_PROFILE="1g.10gb"} * 0.143) +
  sum(DCGM_FI_PROF_GR_ENGINE_ACTIVE{pod="your-pod", GPU_I_PROFILE="2g.20gb"} * 0.286)
) / (
  count(DCGM_FI_PROF_GR_ENGINE_ACTIVE{pod="your-pod", GPU_I_PROFILE="1g.10gb"}) * 0.143 +
  count(DCGM_FI_PROF_GR_ENGINE_ACTIVE{pod="your-pod", GPU_I_PROFILE="2g.20gb"}) * 0.286
)
```

## 🎯 언제 어떤 방식을 사용하나요?

### ✅ 원메트릭 (단순 평균) 사용 시
- 빠른 개요 파악
- 인스턴스 개별 성능 비교
- 간단한 모니터링

### ✅ 가중 평균 사용 시
- **정확한 GPU 활용률 측정**
- **비용 분석 및 최적화**
- **리소스 계획 수립**
- **알림 및 임계값 설정**

## 🔧 실제 사용률 차이 분석

### 차이가 큰 경우
**시나리오 1: 큰 인스턴스가 저사용률**
- `1g.10gb` × 3개: 90% (높음)
- `3g.40gb` × 1개: 30% (낮음)

```
원메트릭: 72.5%
가중 평균: 51.4%
→ 큰 차이! 실제로는 GPU가 많이 남음
```

### 차이가 작은 경우
**시나리오 2: 모든 인스턴스 비슷한 사용률**
- `1g.10gb` × 3개: 80%
- `2g.20gb` × 1개: 82%

```
원메트릭: 80.5%
가중 평균: 80.8%
→ 거의 비슷함
```

## 📋 MIG 프로파일 가중치 표 (A100 기준)

| GPU Instance Profile | 슬라이스 | 가중치 | 메모리 | SM 개수 |
|---------------------|---------|-------|-------|---------|
| `1g.10gb`           | 1/7     | 0.143  | 10GB  | 14      |
| `2g.20gb`           | 2/7     | 0.286  | 20GB  | 28      |
| `3g.40gb`           | 3/7     | 0.429  | 40GB  | 42      |
| `4g.40gb`           | 4/7     | 0.571  | 40GB  | 56      |
| `7g.80gb`           | 7/7     | 1.000  | 80GB  | 108     |

## 💡 핵심 메시지

### 🎯 한 줄 요약
> **"원메트릭은 인스턴스 중심 관점,  
> 가중 평균은 하드웨어 리소스 중심 관점입니다."**

### 📊 어떤 방식이 정답일까요?

**정답은 "목적에 따라 다릅니다"**

| 목적 | 사용할 방식 | 이유 |
|------|-------------|------|
| **GPU 서버 비용 산정** | 가중 평균 | 실제 하드웨어 사용량 반영 |
| **전력 소비 예측** | 가중 평균 | 큰 인스턴스가 더 많은 전력 사용 |
| **개발팀 성능 비교** | 원메트릭 | 인스턴스 크기에 상관없이 공평한 비교 |
| **알림 임계값 설정** | 가중 평균 | 실제 하드웨어 부하 기준 |
| **개별 작업 모니터링** | 원메트릭 | 각 작업의 실제 사용률 |
| **GPU 구매 계획** | 가중 평균 | 실제 리소스 수요 파악 |

### 🔍 실무 적용 가이드
- **모니터링**: 가중 평균 사용
- **알림 설정**: 가중 평균 90% 이상
- **일상 점검**: 원메트릭도 OK
- **리소스 계획**: 반드시 가중 평균

## 📝 실제 적용 사례

### 케이스 1: 개발 환경
- `1g.10gb` 인스턴스 여러 개로 개발자별 할당
- 원메트릭으로 개발자별 사용률 비교
- 가중 평균으로 전체 서버 사용률 파악

### 케이스 2: 프로덕션 환경
- `2g.20gb`, `3g.40gb` 혼합 사용
- 반드시 가중 평균으로 모니터링
- 비용 최적화 시 가중 평균 기준 의사결정

### 케이스 3: 머신러닝 훈련
- 큰 모델: `7g.80gb` 단독 사용
- 작은 모델: `1g.10gb` 여러 개
- 가중 평균으로 실제 GPU 활용률 측정

## 🚨 주의사항 및 베스트 프랙티스

### 1. 동적 환경 고려
- MIG 구성이 런타임에 변경될 수 있음
- 가중치 계산 시 현재 활성 인스턴스 확인 필요

### 2. 모니터링 도구 설정
- Grafana 대시보드에 두 방식 모두 표시
- 알림은 가중 평균 기준 설정 권장

### 3. 보고 및 분석
- **경영진 보고**: 가중 평균 사용
- **기술 분석**: 상황에 따라 선택
- **문제 해결**: 인스턴스별 개별 확인

## 🎯 결론: 두 방식 모두 유효한 "사용률"

### 📋 핵심 정리

1. **원메트릭과 가중 평균 모두 "사용률"이 맞습니다**
   - 단지 관점이 다를 뿐입니다

2. **원메트릭**: 인스턴스 중심 관점
   - "각 작업들이 평균적으로 얼마나 사용하는가?"
   - 개발팀 비교, 개별 작업 모니터링에 적합

3. **가중 평균**: 하드웨어 리소스 중심 관점
   - "물리적 GPU가 얼마나 활용되고 있는가?"
   - 비용 산정, 전력 예측, 용량 계획에 적합

### 🎯 실무 권장사항

**대시보드에서는 두 방식 모두 표시하세요**:
- 원메트릭: "인스턴스 평균 사용률"
- 가중 평균: "GPU 하드웨어 활용률"

**용도별 선택 기준**:
- **관리자 관점**: 가중 평균 (비용, 전력, 용량)
- **개발자 관점**: 원메트릭 (각 작업의 성능)
- **운영자 관점**: 둘 다 (상황에 따라 선택)

---

**문서 작성일**: 2025년  
**목적**: MIG 환경에서 GPU 사용률 메트릭 이해 및 올바른 활용  
**단위**: 퍼센트(%)  
**핵심 메시지**: 두 방식 모두 유효하며, 목적에 맞는 선택이 중요 